// ## Initial Imports and Global Variables ###

// Import external scripts
var IndicesFunc = require('users/eorsgee/DSC-Delta-Task2:IndexFunctions');

// Import baseline ImageCollection
var primaryImageCollection = ee.ImageCollection('COPERNICUS/S2_SR');

// Use the start of the collection and now to bound the slider.
var globalStart = ee.Image(primaryImageCollection.first()).date().get('year').format();
var globalNow = Date.now();
var globalEnd = ee.Date(globalNow).format();

// ### Initial Script Preferences ###
// Note: Some of these are modified by UI widgets!
var prefs = {
  "tile": '10SFH',
  "ccLimit": 20,
  "index_nir": "B8",
  "index_red": "B4",
  "index_green": "B3",
  "index_blue": "B2",
  "preview_red": "TCI_R",
  "preview_green": "TCI_G",
  "preview_blue": "TCI_B",
  "l_correction_factor": 0.5,
  "date_range": ee.DateRange(globalStart, globalEnd)
}

// ### Create UI Layout ###
var mainPanel = ui.Panel({
  layout: ui.Panel.Layout.flow('vertical'),
  style: {width: '300px'}
});

// Cloud Filter Items
var cloudFilterPanel = ui.Panel({
  layout: ui.Panel.Layout.flow('vertical')
});
mainPanel.add(cloudFilterPanel);

var cloudFilterLabel = ui.Label('Cloud Cover Filter (%)');
cloudFilterLabel.style().set({fontSize: '20px'});
cloudFilterPanel.add(cloudFilterLabel);

var cloudFilterSlider = ui.Slider(0, 100, prefs.ccLimit, 1, function(value) {
  prefs.ccLimit = value;
});
cloudFilterSlider.style().set({stretch: 'horizontal'});
cloudFilterPanel.add(cloudFilterSlider);

// Date Filter Items
var datesSelectorPanel = ui.Panel({
  layout: ui.Panel.Layout.flow('vertical')
});
mainPanel.add(datesSelectorPanel);
var dateSelectorLabel = ui.Label('Date Filter Selector');
dateSelectorLabel.style().set({fontSize: '20px'});
datesSelectorPanel.add(dateSelectorLabel);

var startDatePanel = ui.Panel({
  layout: ui.Panel.Layout.flow('horizontal')
});
datesSelectorPanel.add(startDatePanel);
startDatePanel.add(ui.Label('Start Date: '));

var endDatePanel = ui.Panel({
  layout: ui.Panel.Layout.flow('horizontal')
});
datesSelectorPanel.add(endDatePanel);
endDatePanel.add(ui.Label('End Date: '));

var runPanel = ui.Panel({
  layout: ui.Panel.Layout.flow('vertical')
});
mainPanel.add(runPanel);

var runPanelLabel = ui.Label('Processing');
runPanelLabel.style().set({fontSize: '20px'});
runPanel.add(runPanelLabel);

var runProcessingButton = ui.Button({
  label: 'Run Processing',
  onClick: function() {
    runProcessing();
  }
});
runPanel.add(runProcessingButton);

// ### Create Date Selector Widgets ###

// Run this function on a change of the dateSlider.
var showMosaic = function(range) {
  
  // Re-run filters, etc.
  primaryImageCollection = primaryImageCollection
                            .filter(ee.Filter.date(range.start(), range.end()))
                            .filter(ee.Filter.lte('CLOUDY_PIXEL_PERCENTAGE', prefs.ccLimit));
  
  // Compute Mosaic
  var mosaic = primaryImageCollection.mosaic();
  
  // Display Preview Layer
  var visParams = {bands: [prefs.preview_red, prefs.preview_green, prefs.preview_blue], max: 256};
  var layer = ui.Map.Layer(mosaic, visParams, 'TCI Preview');
  Map.layers().set(0, layer);
};

var changeStart = function(range) {
  prefs.date_range = ee.DateRange(range.start(), prefs.date_range.end());
  
  showMosaic(prefs.date_range);
  
  print(prefs.date_range);
}

var changeEnd = function(range) {
  prefs.date_range = ee.DateRange(prefs.date_range.start(), range.end());
  
  showMosaic(prefs.date_range);
  
  print(prefs.date_range);
}

// Asynchronously compute the date range and show the slider.
var startDateRange = prefs.date_range.evaluate(function(range) {
  var startDateSlider = ui.DateSlider({
    start: range['dates'][0],
    end: range['dates'][1],
    value: null,
    period: 1,
    style: {stretch: 'horizontal'},
    onChange: changeStart
  });
  startDatePanel.add(startDateSlider.setValue(range['dates'][0]));
});

var endDateRange = prefs.date_range.evaluate(function(range) {
  var endDateSlider = ui.DateSlider({
    start: range['dates'][0],
    end: range['dates'][1],
    value: null,
    period: 1,
    style: {stretch: 'horizontal'},
    onChange: changeEnd
  });
  endDatePanel.add(endDateSlider.setValue(globalNow));
});

// ### Configure and Add UI ###
// ui.root.clear();
ui.root.add(mainPanel);

// ### Run Processing ###
var runProcessing = function() {
  
  // Mask Clouds
  var cloudMasked = primaryImageCollection.map(IndicesFunc.maskS2clouds);
  
  // Compute Mosaic
  var mosaic = cloudMasked.mosaic();
  
  // Create a color table for the charts
  var color_table = {
    0: {color: "1abc9c"},
    1: {color: "e74c3c"},
    2: {color: "3498db"},
    3: {color: "9b59b6"},
    4: {color: "34495e"},
    5: {color: "f1c40f"},
    6: {color: "e67e22"},
    7: {color: "2ecc71"}
  }
  
  // Calculate Indices
  var calculatedIndices = ee.ImageCollection([
    IndicesFunc.applyNDVI(mosaic),
    IndicesFunc.applyNDAVI(mosaic),
    IndicesFunc.applyWAVI(mosaic)
  ]);
  
  // Merge bands into single Image
  var mergedCalculatedIndices = calculatedIndices.iterate(function(image, previous) {
    return ee.Image(previous).addBands(image);
  }, ee.Image([]));
  
  // [DEBUG] Print calculation results
  print(mergedCalculatedIndices);
  
  // Show Charts
  var testChart = ui.Chart.image.series({
    imageCollection: mergedCalculatedIndices,
    region: geometry,
    reducer: ee.Reducer.mean(),
    xProperty: 'system:time_start'
  })
  
  testChart.setChartType('ScatterChart')
  testChart.setOptions({
    title: '[TESTING] Indices vs. Time (Sentinel-2 L2A) for ALL selected polygons',
    vAxis: {
      title: 'Index Value'
    },
    hAxis: {
      title: "Time"
    },
    lineWidth: 1,
    pointSize: 3,
    series: color_table
  })
  print(testChart);
}